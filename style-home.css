/* Version: 2026-0121-PARALLAX-FIXED - Enhanced Dynamic Parallax with GA4 */
document.addEventListener('DOMContentLoaded', () => {
    const contentSections = document.querySelectorAll('.content-section');
    const logoSection = document.getElementById('logo-section');
    const contactFooterWrapper = document.getElementById('contact-footer-wrapper');
    const hamburgerNavToggle = document.getElementById('hamburger-nav-toggle');
    const hamburgerNavOverlay = document.getElementById('hamburger-nav-overlay');
    const hamburgerNavMenu = document.getElementById('hamburger-nav-menu');
    const hamburgerNavLinks = document.querySelectorAll('#hamburger-nav-menu a');

    // ========== GA4 Event Tracking Helper Function ==========
    function trackEvent(eventName, eventParams = {}) {
        if (typeof gtag !== 'undefined') {
            gtag('event', eventName, eventParams);
            console.log('GA4 Event:', eventName, eventParams);
        }
    }

    // Detect if in English subfolder
    const isEnglishVersion = window.location.pathname.includes('/en/');
    const imagePrefix = isEnglishVersion ? '../images01/' : 'images01/';

    // Set background images dynamically
    const bgMappings = [
        { selector: '#logo-section .parallax-bg', image: 'top.webp' },
        { selector: '#about .parallax-bg', image: 'B-1-ABOUT.webp' },
        { selector: '#catering .parallax-bg', image: 'C-1-F&B.webp' },
        { selector: '#venue .parallax-bg', image: 'D-1-PLACE.webp' },
        { selector: '#event-catering .parallax-bg', image: 'E-1-EVENT.webp' },
        { selector: '#custom-gifts .parallax-bg', image: 'F-1-GIFT.webp' },
        { selector: '#corporate-catering .parallax-bg', image: 'G-1-ENTERPRISE.webp' },
        { selector: '#private-chef .parallax-bg', image: 'H-1-KITCHEN.webp' },
        { selector: '#contact-footer-wrapper .parallax-bg', image: 'I-1-CONTACT.webp' }
    ];

    bgMappings.forEach(mapping => {
        const element = document.querySelector(mapping.selector);
        if (element) {
            element.style.backgroundImage = `url('${imagePrefix}${mapping.image}')`;
        }
    });

    // Check if mobile landscape mode
    function isLandscapeMobile() {
        return window.matchMedia("(orientation: landscape)").matches && window.innerHeight < 500;
    }

    // Check if portrait device (mobile & tablet)
    function isPortraitDevice() {
        return window.innerWidth <= 834 && window.matchMedia("(orientation: portrait)").matches;
    }

    // === 增強型視差效果：垂直移動 + 縮放，根據滾動位置動態變化 ===
    function updateDynamicParallax() {
        const scrollY = window.pageYOffset || window.scrollY || 0;
        const windowHeight = window.innerHeight;
        
        // 處理所有 content sections
        contentSections.forEach((section, index) => {
            const parallaxBg = section.querySelector('.parallax-bg');
            if (!parallaxBg) return;
            
            const rect = section.getBoundingClientRect();
            const sectionTop = rect.top + scrollY;
            const sectionHeight = rect.height;
            const sectionMiddle = sectionTop + (sectionHeight / 2);
            
            // 計算區塊相對於視窗中心的位置
            const viewportMiddle = scrollY + (windowHeight / 2);
            const rawDistance = sectionMiddle - viewportMiddle;
            const distanceFromCenter = rawDistance / windowHeight;
            
            // 每個區塊有不同的視差速度係數（根據索引創造層次感）
            const baseSpeed = 0.15;
            const speedIncrement = 0.05;
            const speedFactor = baseSpeed + (index * speedIncrement);
            
            // 計算垂直位移（限制範圍避免露底）
            const maxTranslateY = 12;
            let translateY = distanceFromCenter * speedFactor * 100;
            translateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, translateY));
            
            // 計算縮放（根據距離動態變化）
            const absDistance = Math.abs(distanceFromCenter);
            let scale = 1.0;
            
            if (absDistance < 0.3) {
                scale = 1.0;
            } else if (absDistance < 0.8) {
                const t = (absDistance - 0.3) / 0.5;
                scale = 1.0 + (t * 0.12);
            } else {
                const t = Math.min((absDistance - 0.8) / 0.5, 1.0);
                scale = 1.12 + (t * 0.18);
            }
            
            scale = Math.min(scale, 1.3);
            
            // 應用變換
            parallaxBg.style.transform = `translateY(${translateY}%) scale(${scale})`;
        });
        
        // 處理 contact-footer-wrapper
        if (contactFooterWrapper) {
            const parallaxBg = contactFooterWrapper.querySelector('.parallax-bg');
            if (parallaxBg) {
                const rect = contactFooterWrapper.getBoundingClientRect();
                const sectionTop = rect.top + scrollY;
                const sectionHeight = rect.height;
                const sectionMiddle = sectionTop + (sectionHeight / 2);
                
                const viewportMiddle = scrollY + (windowHeight / 2);
                const rawDistance = sectionMiddle - viewportMiddle;
                const distanceFromCenter = rawDistance / windowHeight;
                
                const speedFactor = 0.12;
                
                const maxTranslateY = 12;
                let translateY = distanceFromCenter * speedFactor * 100;
                translateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, translateY));
                
                const absDistance = Math.abs(distanceFromCenter);
                let scale = 1.0;
                
                if (absDistance < 0.3) {
                    scale = 1.0;
                } else if (absDistance < 0.8) {
                    const t = (absDistance - 0.3) / 0.5;
                    scale = 1.0 + (t * 0.12);
                } else {
                    const t = Math.min((absDistance - 0.8) / 0.5, 1.0);
                    scale = 1.12 + (t * 0.18);
                }
                
                scale = Math.min(scale, 1.3);
                
                parallaxBg.style.transform = `translateY(${translateY}%) scale(${scale})`;
            }
        }
    }

    // === 使用 requestAnimationFrame 優化滾動效能 ===
    let ticking = false;
    
    function handleScroll() {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                updateDynamicParallax();
                ticking = false;
            });
            ticking = true;
        }
    }
    
    window.addEventListener('scroll', handleScroll, { passive: true });

    // 視窗大小改變時重新計算
    let resizeTicking = false;
    
    function handleResize() {
        if (!resizeTicking) {
            window.requestAnimationFrame(() => {
                updateDynamicParallax();
                resizeTicking = false;
            });
            resizeTicking = true;
        }
    }
    
    window.addEventListener('resize', handleResize, { passive: true });

    // 初始執行（延遲確保 DOM 完全載入）
    setTimeout(() => {
        updateDynamicParallax();
    }, 100);

    // === Content animation observer ===
    const observerOptions = {
        root: null,
        threshold: isLandscapeMobile() ? 0.1 : 0.25,
        rootMargin: '0px 0px -10% 0px'
    };

    const contentObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const contentContainer = entry.target.querySelector('.content-container');
            if (entry.isIntersecting) {
                if (contentContainer) {
                    contentContainer.classList.add('visible');
                    contentContainer.classList.remove('fade-out');
                }
            } else {
                if (contentContainer) {
                    contentContainer.classList.remove('visible');
                    contentContainer.classList.add('fade-out');
                }
            }
        });
    }, observerOptions);

    // Observe all sections
    contentSections.forEach(section => {
        contentObserver.observe(section);
    });
    
    // Separately observe Contact Section
    const contactSection = document.getElementById('contact');
    if (contactSection) {
        contentObserver.observe(contactSection);
    }

    // ========== GA4: Track when user scrolls to Contact Section ==========
    let contactTracked = false;
    const contactObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !contactTracked) {
                trackEvent('scroll_to_contact', {
                    section_name: 'Contact Us'
                });
                contactTracked = true;
            }
        });
    }, { threshold: 0.5 });

    if (contactSection) {
        contactObserver.observe(contactSection);
    }

    // === Logo initial animation ===
    if (logoSection) {
        const parallaxBg = logoSection.querySelector('.parallax-bg');
        
        // Initial state: blurred + zoomed
        logoSection.classList.add('initial-blur');
        if (parallaxBg) {
            parallaxBg.style.transform = 'translateY(0%) scale(1.8)';
        }
        
        setTimeout(() => {
            logoSection.classList.remove('initial-blur'); 
            logoSection.classList.add('fade-out-overlay');
            logoSection.classList.add('loaded');
            
            // 立即執行視差效果計算
            setTimeout(() => {
                updateDynamicParallax();
            }, 150);
        }, 500);
    }

    // === Hamburger menu ===
    if (hamburgerNavToggle && hamburgerNavOverlay) {
        hamburgerNavToggle.addEventListener('click', function() {
            const isOpen = hamburgerNavOverlay.style.display === 'flex';
            hamburgerNavOverlay.style.display = isOpen ? 'none' : 'flex';
            hamburgerNavToggle.setAttribute('aria-expanded', !isOpen);
            
            if (isOpen) {
                hamburgerNavToggle.classList.remove('active');
                hamburgerNavToggle.blur();
                trackEvent('menu_close', {
                    menu_type: 'hamburger_navigation'
                });
            } else {
                hamburgerNavToggle.classList.add('active');
                trackEvent('menu_open', {
                    menu_type: 'hamburger_navigation'
                });
            }
        });
        
        hamburgerNavOverlay.addEventListener('click', function(e) {
            if (e.target === hamburgerNavOverlay) {
                hamburgerNavOverlay.style.display = 'none';
                hamburgerNavToggle.classList.remove('active');
                hamburgerNavToggle.setAttribute('aria-expanded', 'false');
                trackEvent('menu_close', {
                    menu_type: 'hamburger_navigation',
                    close_method: 'overlay_click'
                });
            }
        });
    }

    // === Hamburger menu link click handling ===
    hamburgerNavLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            const linkText = this.textContent.trim();
            
            trackEvent('navigation_click', {
                link_text: linkText,
                link_url: href,
                link_type: 'hamburger_menu'
            });
            
            // Special handling only for anchor links (#contact)
            if (href === '#contact') {
                e.preventDefault();
                const targetElement = document.getElementById('contact');
                if (targetElement) {
                    if (hamburgerNavOverlay) {
                        hamburgerNavOverlay.style.display = 'none';
                        hamburgerNavToggle.classList.remove('active');
                        hamburgerNavToggle.setAttribute('aria-expanded', 'false');
                    }
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
    });

    // ========== GA4: Track Social Media Clicks ==========
    const socialLinks = document.querySelectorAll('.social-icons a');
    socialLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            let platform = 'unknown';
            
            if (href.includes('instagram.com')) {
                platform = 'Instagram';
            } else if (href.includes('facebook.com')) {
                platform = 'Facebook';
            } else if (href.includes('line') || href.includes('reurl.cc')) {
                platform = 'Line';
            }
            
            trackEvent('social_click', {
                platform: platform,
                link_url: href
            });
        });
    });

    // ========== GA4: Track Email Clicks ==========
    const emailLinks = document.querySelectorAll('a[href^="mailto:"]');
    emailLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const email = this.getAttribute('href').replace('mailto:', '');
            
            trackEvent('email_click', {
                email_address: email,
                link_location: 'footer'
            });
        });
    });

    // ========== GA4: Track Service Page Clicks ==========
    const serviceLinks = document.querySelectorAll('.section-link');
    serviceLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            const sectionId = this.closest('.content-section')?.id || 'unknown';
            const heading = this.querySelector('h2')?.textContent.trim() || 'Unknown Service';
            
            trackEvent('service_click', {
                service_name: heading,
                service_url: href,
                section_id: sectionId
            });
        });
    });

    // ========== GA4: Track Language Switch ==========
    const langSwitchBtns = document.querySelectorAll('.lang-switch, .lang-switch-btn');
    langSwitchBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            const targetLang = this.textContent.trim();
            const currentLang = isEnglishVersion ? 'English' : 'Chinese';
            
            trackEvent('language_switch', {
                from_language: currentLang,
                to_language: targetLang === 'ENG' ? 'English' : 'Chinese'
            });
        });
    });

    // ========== GA4: Track Page View ==========
    trackEvent('page_view', {
        page_title: document.title,
        page_location: window.location.href,
        page_path: window.location.pathname,
        language: isEnglishVersion ? 'en' : 'zh'
    });

    // ========== GA4: Track Scroll Depth ==========
    let scrollDepthTracked = {
        '25': false,
        '50': false,
        '75': false,
        '100': false
    };

    window.addEventListener('scroll', () => {
        const scrollPercent = Math.round(
            (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100
        );

        Object.keys(scrollDepthTracked).forEach(depth => {
            if (scrollPercent >= parseInt(depth) && !scrollDepthTracked[depth]) {
                trackEvent('scroll_depth', {
                    percent_scrolled: depth
                });
                scrollDepthTracked[depth] = true;
            }
        });
    }, { passive: true });
});